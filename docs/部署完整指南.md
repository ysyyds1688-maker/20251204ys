# 部署完整指南

## 📋 概述

本指南整合了所有部署相關的內容，包括 Zeabur 部署、構建錯誤修復、常見問題排查等。

---

## 🚀 Zeabur 部署步驟

### 部署前準備

1. **確認專案已推送到 GitHub**
   ```bash
   git push origin main
   ```

2. **檢查本地構建是否正常**
   ```bash
   npm install
   npm run build
   npm run preview
   ```

### 方法 1：透過 Zeabur Dashboard（推薦）

1. **登入 Zeabur**
   - 前往 https://zeabur.com
   - 使用 GitHub 帳號登入

2. **連接 GitHub Repository**
   - 點擊 "New Project"
   - 選擇 "Import from GitHub"
   - 選擇你的 repository

3. **配置部署設定**

   **專案類型**：選擇 **"Static Site"** 或 **"Node.js"**

   **如果是 Static Site 模式**：
   - Build Command: `npm run build`
   - Output Directory: `dist`
   - Install Command: `npm install`

   **如果是 Node.js 模式**：
   - Build Command: `npm run build`
   - Start Command: `npm start`
   - Install Command: `npm install`
   - Port: `3000`

4. **環境變數設定（如果需要）**
   - 如果專案需要 `GEMINI_API_KEY`，在 Zeabur Dashboard 的 Environment Variables 中設定
   - 變數名稱：`GEMINI_API_KEY`
   - 變數值：你的 API Key

5. **部署**
   - 點擊 "Deploy"
   - 等待構建完成

---

## ⚙️ 部署配置說明

### Build 配置

- **Build Command**: `npm run build`
  - 使用 `NODE_OPTIONS=--max-old-space-size=1024` 避免記憶體不足
  - 輸出到 `dist/` 目錄

### Start 配置（Node.js 模式）

- **Start Command**: `npm start`
  - 使用 `vite preview` 預覽構建後的靜態檔案
  - 監聽 `0.0.0.0:3000`

### 靜態網站模式（推薦）

如果 Zeabur 支援靜態網站模式，建議使用：
- 更快的部署速度
- 更低的資源消耗
- 自動 CDN 加速

### zeabur.json 配置

已創建 `zeabur.json` 配置文件：

```json
{
  "build": {
    "command": "npm run build",
    "outputDirectory": "dist"
  },
  "routes": [
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}
```

---

## 🔧 構建錯誤修復

### 問題 1：ReferenceError（'h'、'm'、'r' 錯誤）

**問題描述**：
部署後文章頁面出現黑屏，主控台錯誤：
```
ReferenceError: Cannot access 'r' before initialization
```

**根本原因**：
1. 代碼分割導致的初始化順序問題
2. Temporal Dead Zone (TDZ) 問題
3. 構建優化過於激進

**修復方案**（已在 `vite.config.ts` 中實施）：

1. **禁用代碼分割**：
   ```typescript
   rollupOptions: {
     output: {
       manualChunks: () => 'index', // 強制使用單一 bundle
     },
   }
   ```

2. **使用更保守的變數綁定**：
   ```typescript
   generatedCode: {
     constBindings: false, // 使用 let 而不是 const
     objectShorthand: false,
   }
   ```

3. **使用 esbuild 壓縮**：
   ```typescript
   minify: 'esbuild', // 更穩定的壓縮方式
   ```

### 問題 2：package.json name 字段非法字符

**問題**：
- 原值：`"name": "ys-娛樂論壇"`（包含中文字符）
- npm 要求 name 字段只能包含小寫字母、數字和連字符

**修復**：
- 已改為：`"name": "ys-entertainment-forum"`
- 符合 npm 命名規範

### 問題 3：publicProcedure 錯誤

**錯誤信息**：
```
ReferenceError: publicProcedure is not defined
```

**問題分析**：
- 當前項目是前端 React 項目，不包含任何 `publicProcedure` 相關代碼
- `publicProcedure` 是 tRPC 框架的 API，通常用於後端
- 可能是混合部署問題或構建配置問題

**解決方案**：
1. 確認構建產物不包含後端代碼
2. 檢查 Vite 配置
3. 確認部署配置正確
4. 分離前後端（如果有的話）

---

## 🔍 常見問題排查

### 1. 構建失敗：記憶體不足

**解決方案**：
- 已在 `package.json` 中設定 `NODE_OPTIONS=--max-old-space-size=1024`
- 如果仍失敗，可在 Zeabur 環境變數中設定：
  - `NODE_OPTIONS=--max-old-space-size=2048`

### 2. 頁面顯示 404

**原因**：SPA 路由需要重定向到 `index.html`

**解決方案**：
- 使用 Zeabur 的 Static Site 模式（自動處理）
- 或使用 `zeabur.json` 配置（已創建）

### 3. 圖片無法載入

**檢查**：
- 確認 `public/images/` 所有圖片都已上傳到 GitHub
- 確認圖片路徑正確（使用相對路徑）

### 4. API 請求失敗

**檢查**：
- 確認環境變數已設定
- 確認 API Key 正確
- 檢查 CORS 設定

### 5. 文章頁面黑屏

**檢查清單**：
1. ✅ 檢查主控台是否有 JavaScript 錯誤
2. ✅ 確認構建配置正確（參考構建錯誤修復）
3. ✅ 確認 React 版本一致（已降級到 18.3.1）
4. ✅ 確認 Vite 配置正確（已禁用代碼分割）

---

## 📝 部署檢查清單

- [ ] GitHub repository 已推送最新程式碼
- [ ] 本地 `npm run build` 成功
- [ ] 本地 `npm run preview` 正常顯示
- [ ] Zeabur 專案已連接 GitHub
- [ ] Build Command 設定正確
- [ ] Output Directory 設定為 `dist`
- [ ] 環境變數已設定（如需要）
- [ ] 部署成功並可正常訪問
- [ ] 所有頁面正常顯示
- [ ] 圖片正常載入
- [ ] 文章頁面正常顯示

---

## 💡 優化建議

### 1. 使用 Static Site 模式

如果 Zeabur 支援，優先使用靜態網站模式：
- 更快的載入速度
- 自動 CDN 分發
- 更低的成本

### 2. 啟用快取

- 靜態資源（圖片、CSS、JS）設定長期快取
- HTML 設定短期快取

### 3. 圖片優化

- 所有圖片已壓縮（90MB → 24MB）
- 建議使用 WebP 格式進一步優化

### 4. 構建優化

- 已禁用代碼分割（避免初始化順序問題）
- 使用 esbuild 壓縮（更穩定）
- 已移除 React.StrictMode（避免開發模式雙重渲染）

---

## 🔗 相關文件

- `Git_GitHub操作指南.md` - Git/GitHub 操作說明
- `分類對應完整指南.md` - 分類對應關係
- `vite.config.ts` - 構建配置

---

## 🆘 需要協助？

如果部署遇到問題：

1. **檢查 Zeabur 部署日誌**
2. **參考本指南的常見問題排查**
3. **檢查構建配置**（`vite.config.ts`）
4. **聯繫 Zeabur 支援團隊**

