// ============================================
// n8n Code ç¯€é»ï¼šè§£æ AI å›æ‡‰ï¼ˆè™•ç† article çµæ§‹ï¼‰
// åŠŸèƒ½ï¼šè§£æ AI Agent è¿”å›çš„ article ç‰©ä»¶ï¼Œè½‰æ›æˆ HTML æ ¼å¼çš„ body
// ============================================

const item = $input.item.json;

console.log('=== ğŸ” é–‹å§‹è§£æ AI Agent è¼¸å‡º ===');

// ============================================
// æ­¥é©Ÿ 1ï¼šå–å¾— AI Agent çš„è¼¸å‡º
// ============================================

// å¾ output æ¬„ä½å–å¾—ï¼ˆAI Agent é€šå¸¸æœƒæŠŠå›æ‡‰æ”¾åœ¨ output æ¬„ä½ï¼‰
let aiOutput = item.output || item.response || item.content || item.text || '';

console.log('ğŸ“¥ AI è¼¸å‡ºä¾†æº:', item.output ? 'item.output' : (item.response ? 'item.response' : 'å…¶ä»–'));
console.log('ğŸ“¥ AI è¼¸å‡ºé¡å‹:', typeof aiOutput);
console.log('ğŸ“¥ AI è¼¸å‡ºé•·åº¦:', aiOutput ? aiOutput.toString().length : 0);

if (!aiOutput || aiOutput.toString().trim().length === 0) {
  console.error('âŒ AI Agent æ²’æœ‰è¿”å›ä»»ä½•å…§å®¹');
  throw new Error('AI Agent æ²’æœ‰è¿”å›ä»»ä½•å…§å®¹');
}

// ============================================
// æ­¥é©Ÿ 2ï¼šæ¸…ç†ä¸¦è§£æ JSON
// ============================================

let aiData = null;

// å¦‚æœæ˜¯å­—ä¸²ï¼Œéœ€è¦è§£æ
if (typeof aiOutput === 'string') {
  console.log('ğŸ“ AI è¼¸å‡ºæ˜¯å­—ä¸²ï¼Œé–‹å§‹è§£æ...');
  console.log('ğŸ“ åŸå§‹è¼¸å‡ºå‰ 500 å­—:', aiOutput.substring(0, 500));
  
  // æ¸…ç† markdown åŒ…è£¹
  let cleanedResponse = aiOutput
    .replace(/```json\s*/gi, '')
    .replace(/```\s*/g, '')
    .replace(/^[\s\n]*/, '')
    .replace(/[\s\n]*$/, '')
    .trim();
  
  console.log('ğŸ§¹ æ¸…ç†å¾Œé•·åº¦:', cleanedResponse.length);
  
  // è§£æ JSON
  try {
    aiData = JSON.parse(cleanedResponse);
    console.log('âœ… JSON è§£ææˆåŠŸ');
  } catch (e) {
    // å˜—è©¦æå– JSON éƒ¨åˆ†
    const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      aiData = JSON.parse(jsonMatch[0]);
      console.log('âœ… ä½¿ç”¨æ­£å‰‡åŒ¹é…è§£ææˆåŠŸ');
    } else {
      console.error('âŒ ç„¡æ³•è§£æ JSON:', e.message);
      throw new Error(`ç„¡æ³•è§£æ AI å›æ‡‰ç‚º JSON: ${e.message}`);
    }
  }
} else if (typeof aiOutput === 'object') {
  // å¦‚æœå·²ç¶“æ˜¯ç‰©ä»¶ï¼Œç›´æ¥ä½¿ç”¨
  aiData = aiOutput;
  console.log('âœ… AI è¼¸å‡ºå·²ç¶“æ˜¯ç‰©ä»¶ï¼Œç›´æ¥ä½¿ç”¨');
} else {
  throw new Error(`ä¸æ”¯æ´çš„ AI è¼¸å‡ºé¡å‹: ${typeof aiOutput}`);
}

console.log('ğŸ“Š è§£æå¾Œçš„è³‡æ–™æ¬„ä½:', Object.keys(aiData));

// ============================================
// æ­¥é©Ÿ 3ï¼šæå–ä¸¦è½‰æ› article çµæ§‹ç‚º HTML
// ============================================

// æª¢æŸ¥æ˜¯å¦æœ‰ article ç‰©ä»¶
const articleObj = aiData.article || aiData.Article || null;

if (!articleObj) {
  console.error('âŒ æ‰¾ä¸åˆ° article ç‰©ä»¶');
  console.error('å¯ç”¨çš„æ¬„ä½:', Object.keys(aiData));
  
  // å¦‚æœæ²’æœ‰ articleï¼Œå˜—è©¦ç›´æ¥ä½¿ç”¨ body æˆ– content
  const fallbackBody = aiData.body || aiData.content || aiData.Body || aiData.Content || '';
  if (fallbackBody) {
    console.log('âš ï¸ ä½¿ç”¨å‚™ç”¨æ–¹æ¡ˆï¼šç›´æ¥ä½¿ç”¨ body/content æ¬„ä½');
    const articleBody = fallbackBody.toString().trim();
    const articleExcerpt = aiData.meta_description || aiData.description || aiData.excerpt || articleBody.substring(0, 150) + '...';
    const articleTitle = aiData.title || aiData.Title || '';
    
    return {
      json: {
        Keyword: item.Keyword || item.keyword || '',
        Category: item.Category || item.category || '',
        GEO: item.GEO || item.geo || 'TW',
        title: articleTitle || item.Keyword || '',
        body: articleBody,
        Content: articleBody,
        Excerpt: articleExcerpt.toString().trim(),
        Status: 'done',
        Date: new Date().toISOString().split('T')[0]
      }
    };
  }
  
  throw new Error('æ‰¾ä¸åˆ° article ç‰©ä»¶ï¼Œä¸”æ²’æœ‰å¯ç”¨çš„ body/content æ¬„ä½');
}

console.log('âœ… æ‰¾åˆ° article ç‰©ä»¶');
console.log('Article çš„æ¬„ä½:', Object.keys(articleObj));

// ============================================
// æ­¥é©Ÿ 4ï¼šå°‡ article ç‰©ä»¶è½‰æ›æˆ HTML
// ============================================

function convertArticleToHTML(article) {
  let html = '';
  
  // H1 æ¨™é¡Œ
  if (article.h1) {
    html += `<h1>${article.h1}</h1>\n\n`;
  }
  
  // å¼•è¨€
  if (article.introduction) {
    html += `<p>${article.introduction}</p>\n\n`;
  }
  
  // Sectionsï¼ˆæ®µè½ï¼‰
  if (article.sections && Array.isArray(article.sections)) {
    article.sections.forEach(section => {
      // H2 æ¨™é¡Œ
      if (section.h2) {
        html += `<h2>${section.h2}</h2>\n\n`;
      }
      
      // æ®µè½
      if (section.paragraphs && Array.isArray(section.paragraphs)) {
        section.paragraphs.forEach(para => {
          // è™•ç†ç²—é«”æ¨™è¨˜ï¼ˆ**æ–‡å­—** -> <strong>æ–‡å­—</strong>ï¼‰
          const processedPara = para
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>');
          
          html += `<p>${processedPara}</p>\n\n`;
        });
      }
    });
  }
  
  // Conclusionï¼ˆçµè«–ï¼‰
  if (article.conclusion) {
    if (article.conclusion.h3) {
      html += `<h3>${article.conclusion.h3}</h3>\n\n`;
    }
    
    if (article.conclusion.paragraphs && Array.isArray(article.conclusion.paragraphs)) {
      article.conclusion.paragraphs.forEach(para => {
        const processedPara = para
          .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
          .replace(/\*(.*?)\*/g, '<em>$1</em>');
        
        html += `<p>${processedPara}</p>\n\n`;
      });
    }
  }
  
  // æ·»åŠ å…è²¬è²æ˜ï¼ˆå¦‚æœçµè«–ä¸­æ²’æœ‰ï¼‰
  if (!html.includes('å…è²¬è²æ˜') && !html.includes('å…è²¬')) {
    html += `<p style="padding: 1rem; background-color: rgba(251, 191, 36, 0.1); border-left: 4px solid rgba(251, 191, 36, 0.5); border-radius: 0 0.5rem 0.5rem 0; margin-top: 2rem;"><strong style="color: #fbbf24;">å…è²¬è²æ˜ï¼š</strong> ä»¥ä¸Šå…§å®¹ç´”å±¬å€‹äººå»ºè­°èˆ‡ç¶“é©—åˆ†äº«ï¼Œä¸ä»£è¡¨æœ¬è«–å£‡ç«‹å ´ã€‚æ‰€æœ‰è³‡è¨Šåƒ…ä¾›åƒè€ƒï¼Œè«‹è®€è€…è‡ªè¡Œåˆ¤æ–·ä¸¦æ‰¿æ“”é¢¨éšªã€‚æœ¬è«–å£‡ä¸å°ä»»ä½•å› ä½¿ç”¨ä¸Šè¿°è³‡è¨Šè€Œå°è‡´çš„æå¤±è² è²¬ã€‚ç†æ€§æŠ•æ³¨ï¼Œé‡åŠ›è€Œç‚ºã€‚</p>`;
  }
  
  return html.trim();
}

const articleHTML = convertArticleToHTML(articleObj);

console.log('âœ… Article è½‰æ›ç‚º HTML å®Œæˆ');
console.log('ğŸ“ HTML é•·åº¦:', articleHTML.length);
console.log('ğŸ“ HTML å‰ 300 å­—:', articleHTML.substring(0, 300));

if (!articleHTML || articleHTML.length < 100) {
  console.error('âŒ è½‰æ›å¾Œçš„ HTML å¤ªçŸ­æˆ–ç‚ºç©º');
  throw new Error('Article è½‰æ›ç‚º HTML å¾Œå…§å®¹ç‚ºç©ºæˆ–å¤ªçŸ­');
}

// ============================================
// æ­¥é©Ÿ 5ï¼šæå–å…¶ä»–æ¬„ä½
// ============================================

const articleTitle = aiData.title || aiData.Title || articleObj.h1 || '';
const articleExcerpt = aiData.meta_description || aiData.description || aiData.excerpt || articleHTML.substring(0, 150) + '...';

console.log('ğŸ“‹ æå–çµæœ:');
console.log('  - Title:', articleTitle);
console.log('  - Excerpt é•·åº¦:', articleExcerpt.toString().length);
console.log('  - Body (HTML) é•·åº¦:', articleHTML.length);

// ============================================
// æ­¥é©Ÿ 6ï¼šå–å¾—åŸå§‹æ¬„ä½
// ============================================

const originalKeyword = item.Keyword || item.keyword || '';
const originalCategory = item.Category || item.category || '';
const originalGEO = item.GEO || item.geo || 'TW';

console.log('ğŸ“‹ åŸå§‹æ¬„ä½:');
console.log('  - Keyword:', originalKeyword);
console.log('  - Category:', originalCategory);
console.log('  - GEO:', originalGEO);

// ============================================
// æ­¥é©Ÿ 7ï¼šçµ„è£è¼¸å‡º
// ============================================

return {
  json: {
    Keyword: originalKeyword,
    Category: originalCategory,
    GEO: originalGEO,
    title: articleTitle.toString().trim() || originalKeyword,
    body: articleHTML,
    Content: articleHTML, // âš ï¸ é‡è¦ï¼šå®Œæ•´çš„ HTML æ–‡ç« å…§å®¹
    Excerpt: articleExcerpt.toString().trim(),
    Status: 'done',
    Date: new Date().toISOString().split('T')[0]
  }
};

