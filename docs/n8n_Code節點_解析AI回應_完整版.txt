// ============================================
// n8n Code ç¯€é»žï¼šè§£æž AI å›žæ‡‰ä¸¦çµ„è£å®Œæ•´æ¬„ä½
// åŠŸèƒ½ï¼šæ­£ç¢ºè§£æž AI Agent çš„ JSON å›žæ‡‰ï¼Œæå–å®Œæ•´æ–‡ç« å…§å®¹
// ============================================

// ============================================
// æ­¥é©Ÿ 1ï¼šå–å¾— AI Agent çš„è¼¸å‡º
// ============================================

const item = $input.item.json;

// æ–¹æ³• 1ï¼šå¾ž AI Agent çš„ç›´æŽ¥è¼¸å‡ºå–å¾—ï¼ˆå„ªå…ˆï¼‰
let aiOutput = item.response || item.content || item.output || '';

// æ–¹æ³• 2ï¼šå¦‚æžœ AI Agent æœ‰åŒ…è£åœ¨ç‰¹å®šæ¬„ä½ä¸­
if (!aiOutput && item.json) {
  aiOutput = item.json.response || item.json.content || item.json.output || '';
}

// æ–¹æ³• 3ï¼šå¦‚æžœ AI Agent è¿”å›žçš„æ˜¯ç‰©ä»¶ï¼Œç›´æŽ¥ä½¿ç”¨
if (typeof aiOutput === 'object' && aiOutput !== null) {
  // AI Agent å·²ç¶“è¿”å›žè§£æžå¾Œçš„ç‰©ä»¶ï¼Œç›´æŽ¥ä½¿ç”¨
  const articleData = aiOutput;
  
  // æå–æ–‡ç« å…§å®¹
  const articleBody = articleData.body || articleData.content || articleData.Body || '';
  const articleExcerpt = articleData.description || articleData.excerpt || articleData.Description || '';
  const articleTitle = articleData.title || articleData.Title || '';
  
  // é©—è­‰ body æ˜¯å¦ç‚ºç©º
  if (!articleBody || articleBody.toString().trim().length === 0) {
    console.error('âŒ AI å›žæ‡‰ä¸­æ²’æœ‰æ‰¾åˆ°æ–‡ç« å…§å®¹ï¼ˆbody/content æ¬„ä½ç‚ºç©ºï¼‰');
    console.error('AI å›žæ‡‰å…§å®¹:', JSON.stringify(articleData, null, 2));
    throw new Error('AI å›žæ‡‰ä¸­æ²’æœ‰æ‰¾åˆ°æ–‡ç« å…§å®¹ï¼ˆbody æˆ– content æ¬„ä½ç‚ºç©ºï¼‰');
  }
  
  // å–å¾—åŽŸå§‹æ¬„ä½ï¼ˆå¾žå‰é¢çš„ç¯€é»žå‚³éžï¼‰
  const originalKeyword = item.Keyword || item.keyword || '';
  const originalCategory = item.Category || item.category || '';
  const originalGEO = item.GEO || item.geo || 'TW';
  
  console.log(`âœ… æˆåŠŸè§£æž AI å›žæ‡‰ï¼š`);
  console.log(`   - Title: ${articleTitle.substring(0, 50)}...`);
  console.log(`   - Body é•·åº¦: ${articleBody.toString().length} å­—å…ƒ`);
  console.log(`   - Excerpt é•·åº¦: ${articleExcerpt.toString().length} å­—å…ƒ`);
  console.log(`   - Keyword: ${originalKeyword}`);
  console.log(`   - Category: ${originalCategory}`);
  
  // çµ„è£è¼¸å‡º
  return {
    json: {
      Keyword: originalKeyword,
      Category: originalCategory,
      GEO: originalGEO,
      title: articleTitle || originalKeyword,
      body: articleBody.toString().trim(), // ç”¨æ–¼å…§éƒ¨å‚³éž
      Content: articleBody.toString().trim(), // âš ï¸ é‡è¦ï¼šé€™æ˜¯å¯«å…¥ Google Sheet çš„å®Œæ•´æ–‡ç« å…§å®¹
      Excerpt: articleExcerpt.toString().trim() || articleBody.toString().substring(0, 150) + '...',
      Status: 'done',
      Date: new Date().toISOString().split('T')[0]
    }
  };
}

// ============================================
// æ­¥é©Ÿ 2ï¼šå¦‚æžœ AI Agent è¿”å›žçš„æ˜¯å­—ä¸²ï¼ˆJSON æ ¼å¼ï¼‰ï¼Œéœ€è¦è§£æž
// ============================================

if (!aiOutput || typeof aiOutput !== 'string') {
  console.error('âŒ AI Agent æ²’æœ‰è¿”å›žæœ‰æ•ˆçš„å›žæ‡‰');
  console.error('è¼¸å…¥è³‡æ–™:', JSON.stringify(item, null, 2));
  throw new Error('AI Agent æ²’æœ‰è¿”å›žæœ‰æ•ˆçš„å›žæ‡‰');
}

console.log('ðŸ“ åŽŸå§‹ AI å›žæ‡‰é•·åº¦:', aiOutput.length);
console.log('ðŸ“ åŽŸå§‹ AI å›žæ‡‰å‰ 500 å­—:', aiOutput.substring(0, 500));

// ============================================
// æ­¥é©Ÿ 3ï¼šæ¸…ç† AI å›žæ‡‰ï¼ˆç§»é™¤ markdown åŒ…è£¹å’Œé›œè¨Šï¼‰
// ============================================

let cleanedResponse = aiOutput
  .replace(/```json\s*/gi, '')  // ç§»é™¤ ```json
  .replace(/```\s*/g, '')        // ç§»é™¤ ```
  .replace(/^[\s\n]*/, '')       // ç§»é™¤é–‹é ­ç©ºç™½
  .replace(/[\s\n]*$/, '')       // ç§»é™¤çµå°¾ç©ºç™½
  .trim();

console.log('ðŸ§¹ æ¸…ç†å¾Œå›žæ‡‰é•·åº¦:', cleanedResponse.length);

// ============================================
// æ­¥é©Ÿ 4ï¼šè§£æž JSON
// ============================================

let articleData = null;

// æ–¹æ³• 1ï¼šç›´æŽ¥è§£æž
try {
  articleData = JSON.parse(cleanedResponse);
  console.log('âœ… æ–¹æ³• 1 æˆåŠŸï¼šç›´æŽ¥è§£æž JSON');
} catch (e1) {
  console.log('âš ï¸ æ–¹æ³• 1 å¤±æ•—ï¼Œå˜—è©¦æ–¹æ³• 2...');
  
  // æ–¹æ³• 2ï¼šå°‹æ‰¾ JSON ç‰©ä»¶
  try {
    const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
    if (jsonMatch) {
      articleData = JSON.parse(jsonMatch[0]);
      console.log('âœ… æ–¹æ³• 2 æˆåŠŸï¼šæ­£å‰‡åŒ¹é… JSON ç‰©ä»¶');
    }
  } catch (e2) {
    console.log('âš ï¸ æ–¹æ³• 2 å¤±æ•—ï¼Œå˜—è©¦æ–¹æ³• 3...');
    
    // æ–¹æ³• 3ï¼šå°‹æ‰¾ keywords é™£åˆ—ï¼ˆå¦‚æžœæ˜¯é—œéµå­—ç”Ÿæˆï¼‰
    try {
      const arrayMatch = cleanedResponse.match(/\[[\s\S]*\]/);
      if (arrayMatch) {
        const keywordsArray = JSON.parse(arrayMatch[0]);
        articleData = { keywords: keywordsArray };
        console.log('âœ… æ–¹æ³• 3 æˆåŠŸï¼šé™£åˆ—è§£æž');
      }
    } catch (e3) {
      console.error('âŒ æ‰€æœ‰è§£æžæ–¹æ³•éƒ½å¤±æ•—');
      console.error('æ¸…ç†å¾Œçš„å›žæ‡‰å‰ 1000 å­—:', cleanedResponse.substring(0, 1000));
      console.error('éŒ¯èª¤ 1:', e1.message);
      console.error('éŒ¯èª¤ 2:', e2.message);
      console.error('éŒ¯èª¤ 3:', e3.message);
      
      throw new Error('ç„¡æ³•è§£æž AI å›žæ‡‰ï¼Œè«‹æª¢æŸ¥ AI Agent çš„è¼¸å‡ºæ ¼å¼');
    }
  }
}

// ============================================
// æ­¥é©Ÿ 5ï¼šé©—è­‰ä¸¦æå–æ–‡ç« å…§å®¹
// ============================================

if (!articleData) {
  throw new Error('ç„¡æ³•è§£æž AI å›žæ‡‰ç‚º JSON ç‰©ä»¶');
}

// æå–æ–‡ç« å…§å®¹ï¼ˆå„ªå…ˆé †åºï¼šbody > content > Body > Contentï¼‰
const articleBody = articleData.body 
  || articleData.content 
  || articleData.Body 
  || articleData.Content 
  || '';

// æå–æ‘˜è¦ï¼ˆå„ªå…ˆé †åºï¼šdescription > excerpt > Description > Excerptï¼‰
const articleExcerpt = articleData.description 
  || articleData.excerpt 
  || articleData.Description 
  || articleData.Excerpt 
  || '';

// æå–æ¨™é¡Œ
const articleTitle = articleData.title 
  || articleData.Title 
  || articleData.headline 
  || articleData.Headline 
  || '';

// é©—è­‰ body æ˜¯å¦ç‚ºç©º
if (!articleBody || articleBody.toString().trim().length === 0) {
  console.error('âŒ AI å›žæ‡‰ä¸­æ²’æœ‰æ‰¾åˆ°æ–‡ç« å…§å®¹ï¼ˆbody/content æ¬„ä½ç‚ºç©ºï¼‰');
  console.error('AI å›žæ‡‰çš„å¯ç”¨æ¬„ä½:', Object.keys(articleData));
  console.error('AI å›žæ‡‰å…§å®¹:', JSON.stringify(articleData, null, 2).substring(0, 1000));
  throw new Error('AI å›žæ‡‰ä¸­æ²’æœ‰æ‰¾åˆ°æ–‡ç« å…§å®¹ï¼ˆbody æˆ– content æ¬„ä½ç‚ºç©ºï¼‰');
}

// å–å¾—åŽŸå§‹æ¬„ä½ï¼ˆå¾žå‰é¢çš„ç¯€é»žå‚³éžï¼‰
const originalKeyword = item.Keyword || item.keyword || '';
const originalCategory = item.Category || item.category || '';
const originalGEO = item.GEO || item.geo || 'TW';

// ============================================
// æ­¥é©Ÿ 6ï¼šçµ„è£è¼¸å‡º
// ============================================

const bodyString = articleBody.toString().trim();
const excerptString = articleExcerpt.toString().trim() || bodyString.substring(0, 150) + '...';
const titleString = articleTitle.toString().trim() || originalKeyword;

console.log(`âœ… æˆåŠŸè§£æž AI å›žæ‡‰ï¼š`);
console.log(`   - Title: ${titleString.substring(0, 50)}${titleString.length > 50 ? '...' : ''}`);
console.log(`   - Body é•·åº¦: ${bodyString.length} å­—å…ƒ`);
console.log(`   - Excerpt é•·åº¦: ${excerptString.length} å­—å…ƒ`);
console.log(`   - Keyword: ${originalKeyword}`);
console.log(`   - Category: ${originalCategory}`);

// å¦‚æžœ body é•·åº¦å¤ªçŸ­ï¼Œç™¼å‡ºè­¦å‘Š
if (bodyString.length < 500) {
  console.warn(`âš ï¸ è­¦å‘Šï¼šBody é•·åº¦è¼ƒçŸ­ (${bodyString.length} å­—å…ƒ)ï¼Œå¯èƒ½åªåŒ…å«æ‘˜è¦è€Œéžå®Œæ•´å…§å®¹`);
  console.warn(`   Body å‰ 200 å­—: ${bodyString.substring(0, 200)}`);
}

// è¿”å›žçµ„è£å¥½çš„è³‡æ–™
return {
  json: {
    Keyword: originalKeyword,
    Category: originalCategory,
    GEO: originalGEO,
    title: titleString,
    body: bodyString, // ç”¨æ–¼å…§éƒ¨å‚³éž
    Content: bodyString, // âš ï¸ é‡è¦ï¼šé€™æ˜¯å¯«å…¥ Google Sheet çš„å®Œæ•´æ–‡ç« å…§å®¹
    Excerpt: excerptString, // æ‘˜è¦ï¼ˆç”¨æ–¼åˆ—è¡¨é é¡¯ç¤ºï¼‰
    Status: 'done',
    Date: new Date().toISOString().split('T')[0]
  }
};

