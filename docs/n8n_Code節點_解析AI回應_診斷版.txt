// ============================================
// n8n Code ç¯€é»žï¼šè§£æž AI å›žæ‡‰ï¼ˆè¨ºæ–·ç‰ˆï¼‰
// åŠŸèƒ½ï¼šè§£æž AI Agent çš„ JSON å›žæ‡‰ï¼Œä¸¦è¼¸å‡ºè©³ç´°çš„è¨ºæ–·è³‡è¨Š
// ============================================

const item = $input.item.json;

console.log('=== ðŸ” é–‹å§‹è¨ºæ–· AI Agent è¼¸å‡º ===');
console.log('è¼¸å…¥è³‡æ–™çš„æ‰€æœ‰æ¬„ä½:', Object.keys(item));
console.log('è¼¸å…¥è³‡æ–™å®Œæ•´å…§å®¹:', JSON.stringify(item, null, 2).substring(0, 2000));

// ============================================
// æ­¥é©Ÿ 1ï¼šå–å¾— AI Agent çš„è¼¸å‡ºï¼ˆå˜—è©¦å¤šç¨®æ–¹å¼ï¼‰
// ============================================

let aiOutput = null;
let aiOutputSource = '';

// æ–¹æ³• 1ï¼šå¾žå¸¸è¦‹çš„ AI Agent è¼¸å‡ºæ¬„ä½å–å¾—
if (item.response) {
  aiOutput = item.response;
  aiOutputSource = 'item.response';
} else if (item.content) {
  aiOutput = item.content;
  aiOutputSource = 'item.content';
} else if (item.output) {
  aiOutput = item.output;
  aiOutputSource = 'item.output';
} else if (item.json) {
  aiOutput = item.json;
  aiOutputSource = 'item.json';
} else if (item.text) {
  aiOutput = item.text;
  aiOutputSource = 'item.text';
} else if (item.message) {
  aiOutput = item.message;
  aiOutputSource = 'item.message';
} else {
  // å¦‚æžœéƒ½æ²’æœ‰ï¼Œå˜—è©¦ä½¿ç”¨æ•´å€‹ item
  aiOutput = item;
  aiOutputSource = 'item (æ•´å€‹ç‰©ä»¶)';
}

console.log(`ðŸ“¥ AI è¼¸å‡ºä¾†æº: ${aiOutputSource}`);
console.log(`ðŸ“¥ AI è¼¸å‡ºé¡žåž‹: ${typeof aiOutput}`);
console.log(`ðŸ“¥ AI è¼¸å‡ºæ˜¯å¦ç‚º null: ${aiOutput === null}`);
console.log(`ðŸ“¥ AI è¼¸å‡ºæ˜¯å¦ç‚º undefined: ${aiOutput === undefined}`);

if (aiOutput === null || aiOutput === undefined) {
  console.error('âŒ ç„¡æ³•æ‰¾åˆ° AI Agent çš„è¼¸å‡º');
  console.error('è«‹æª¢æŸ¥ AI Agent ç¯€é»žçš„è¼¸å‡ºæ¬„ä½åç¨±');
  throw new Error('ç„¡æ³•æ‰¾åˆ° AI Agent çš„è¼¸å‡ºï¼Œè«‹æª¢æŸ¥ AI Agent ç¯€é»žçš„è¼¸å‡ºæ ¼å¼');
}

// ============================================
// æ­¥é©Ÿ 2ï¼šè™•ç†ä¸åŒé¡žåž‹çš„ AI è¼¸å‡º
// ============================================

let articleData = null;

// æƒ…æ³ 1ï¼šå¦‚æžœ AI è¼¸å‡ºå·²ç¶“æ˜¯ç‰©ä»¶
if (typeof aiOutput === 'object' && aiOutput !== null) {
  console.log('âœ… AI è¼¸å‡ºæ˜¯ç‰©ä»¶ï¼Œç›´æŽ¥ä½¿ç”¨');
  console.log('ç‰©ä»¶çš„æ‰€æœ‰æ¬„ä½:', Object.keys(aiOutput));
  articleData = aiOutput;
} 
// æƒ…æ³ 2ï¼šå¦‚æžœ AI è¼¸å‡ºæ˜¯å­—ä¸²ï¼Œéœ€è¦è§£æž JSON
else if (typeof aiOutput === 'string') {
  console.log(`ðŸ“ AI è¼¸å‡ºæ˜¯å­—ä¸²ï¼Œé•·åº¦: ${aiOutput.length}`);
  console.log(`ðŸ“ AI è¼¸å‡ºå‰ 500 å­—: ${aiOutput.substring(0, 500)}`);
  
  // æ¸…ç†å­—ä¸²ï¼ˆç§»é™¤ markdown åŒ…è£¹ï¼‰
  let cleanedResponse = aiOutput
    .replace(/```json\s*/gi, '')
    .replace(/```\s*/g, '')
    .replace(/^[\s\n]*/, '')
    .replace(/[\s\n]*$/, '')
    .trim();
  
  console.log(`ðŸ§¹ æ¸…ç†å¾Œé•·åº¦: ${cleanedResponse.length}`);
  console.log(`ðŸ§¹ æ¸…ç†å¾Œå‰ 500 å­—: ${cleanedResponse.substring(0, 500)}`);
  
  // å˜—è©¦è§£æž JSON
  try {
    articleData = JSON.parse(cleanedResponse);
    console.log('âœ… æ–¹æ³• 1 æˆåŠŸï¼šç›´æŽ¥è§£æž JSON');
  } catch (e1) {
    console.log('âš ï¸ æ–¹æ³• 1 å¤±æ•—:', e1.message);
    
    // æ–¹æ³• 2ï¼šå°‹æ‰¾ JSON ç‰©ä»¶
    try {
      const jsonMatch = cleanedResponse.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        articleData = JSON.parse(jsonMatch[0]);
        console.log('âœ… æ–¹æ³• 2 æˆåŠŸï¼šæ­£å‰‡åŒ¹é… JSON ç‰©ä»¶');
      } else {
        throw new Error('æ‰¾ä¸åˆ° JSON ç‰©ä»¶');
      }
    } catch (e2) {
      console.error('âŒ æ–¹æ³• 2 å¤±æ•—:', e2.message);
      console.error('æ¸…ç†å¾Œçš„å›žæ‡‰å‰ 1000 å­—:', cleanedResponse.substring(0, 1000));
      throw new Error(`ç„¡æ³•è§£æž AI å›žæ‡‰ç‚º JSON: ${e2.message}`);
    }
  }
} 
// æƒ…æ³ 3ï¼šå…¶ä»–é¡žåž‹
else {
  console.error(`âŒ ä¸æ”¯æ´çš„ AI è¼¸å‡ºé¡žåž‹: ${typeof aiOutput}`);
  throw new Error(`ä¸æ”¯æ´çš„ AI è¼¸å‡ºé¡žåž‹: ${typeof aiOutput}`);
}

// ============================================
// æ­¥é©Ÿ 3ï¼šè¨ºæ–·è§£æžå¾Œçš„è³‡æ–™
// ============================================

console.log('=== ðŸ“Š è§£æžå¾Œçš„è³‡æ–™çµæ§‹ ===');
console.log('æ‰€æœ‰æ¬„ä½:', Object.keys(articleData));
console.log('å®Œæ•´å…§å®¹ (å‰ 2000 å­—):', JSON.stringify(articleData, null, 2).substring(0, 2000));

// æª¢æŸ¥æ¯å€‹å¯èƒ½çš„æ¬„ä½
const possibleBodyFields = ['body', 'content', 'Body', 'Content', 'text', 'Text', 'article', 'Article'];
const possibleExcerptFields = ['description', 'excerpt', 'Description', 'Excerpt', 'summary', 'Summary'];
const possibleTitleFields = ['title', 'Title', 'headline', 'Headline', 'subject', 'Subject'];

console.log('=== ðŸ”Ž æª¢æŸ¥å¯èƒ½çš„æ¬„ä½ ===');

// æª¢æŸ¥ body/content æ¬„ä½
let foundBodyField = null;
let foundBodyValue = null;
for (const field of possibleBodyFields) {
  if (articleData[field] !== undefined && articleData[field] !== null) {
    foundBodyField = field;
    foundBodyValue = articleData[field];
    console.log(`âœ… æ‰¾åˆ° body æ¬„ä½: ${field}, é¡žåž‹: ${typeof foundBodyValue}, é•·åº¦: ${foundBodyValue ? foundBodyValue.toString().length : 0}`);
    break;
  }
}

// æª¢æŸ¥ excerpt/description æ¬„ä½
let foundExcerptField = null;
let foundExcerptValue = null;
for (const field of possibleExcerptFields) {
  if (articleData[field] !== undefined && articleData[field] !== null) {
    foundExcerptField = field;
    foundExcerptValue = articleData[field];
    console.log(`âœ… æ‰¾åˆ° excerpt æ¬„ä½: ${field}, é¡žåž‹: ${typeof foundExcerptValue}, é•·åº¦: ${foundExcerptValue ? foundExcerptValue.toString().length : 0}`);
    break;
  }
}

// æª¢æŸ¥ title æ¬„ä½
let foundTitleField = null;
let foundTitleValue = null;
for (const field of possibleTitleFields) {
  if (articleData[field] !== undefined && articleData[field] !== null) {
    foundTitleField = field;
    foundTitleValue = articleData[field];
    console.log(`âœ… æ‰¾åˆ° title æ¬„ä½: ${field}, å€¼: ${foundTitleValue}`);
    break;
  }
}

// ============================================
// æ­¥é©Ÿ 4ï¼šæå–æ–‡ç« å…§å®¹
// ============================================

const articleBody = foundBodyValue ? foundBodyValue.toString().trim() : '';
const articleExcerpt = foundExcerptValue ? foundExcerptValue.toString().trim() : '';
const articleTitle = foundTitleValue ? foundTitleValue.toString().trim() : '';

console.log('=== ðŸ“ æå–çµæžœ ===');
console.log(`Body æ¬„ä½: ${foundBodyField || 'æœªæ‰¾åˆ°'}, é•·åº¦: ${articleBody.length}`);
console.log(`Excerpt æ¬„ä½: ${foundExcerptField || 'æœªæ‰¾åˆ°'}, é•·åº¦: ${articleExcerpt.length}`);
console.log(`Title æ¬„ä½: ${foundTitleField || 'æœªæ‰¾åˆ°'}, å€¼: ${articleTitle}`);

// å¦‚æžœ body ç‚ºç©ºï¼Œè¼¸å‡ºæ‰€æœ‰æ¬„ä½ä¾›è¨ºæ–·
if (!articleBody || articleBody.length === 0) {
  console.error('âŒ Body æ¬„ä½ç‚ºç©ºï¼');
  console.error('=== æ‰€æœ‰å¯ç”¨çš„æ¬„ä½å’Œå€¼ ===');
  Object.keys(articleData).forEach(key => {
    const value = articleData[key];
    const valueType = typeof value;
    const valueLength = value ? value.toString().length : 0;
    const valuePreview = value ? value.toString().substring(0, 100) : 'null/undefined';
    console.error(`  - ${key}: é¡žåž‹=${valueType}, é•·åº¦=${valueLength}, é è¦½=${valuePreview}`);
  });
  
  throw new Error(`AI å›žæ‡‰ä¸­æ²’æœ‰æ‰¾åˆ°æ–‡ç« å…§å®¹ã€‚æ‰¾åˆ°çš„æ¬„ä½: ${Object.keys(articleData).join(', ')}ã€‚è«‹æª¢æŸ¥ AI Agent çš„è¼¸å‡ºæ ¼å¼ï¼Œç¢ºä¿åŒ…å« 'body' æˆ– 'content' æ¬„ä½ã€‚`);
}

// ============================================
// æ­¥é©Ÿ 5ï¼šå–å¾—åŽŸå§‹æ¬„ä½
// ============================================

const originalKeyword = item.Keyword || item.keyword || '';
const originalCategory = item.Category || item.category || '';
const originalGEO = item.GEO || item.geo || 'TW';

console.log('=== ðŸ“‹ åŽŸå§‹æ¬„ä½ ===');
console.log(`Keyword: ${originalKeyword}`);
console.log(`Category: ${originalCategory}`);
console.log(`GEO: ${originalGEO}`);

// ============================================
// æ­¥é©Ÿ 6ï¼šçµ„è£è¼¸å‡º
// ============================================

const finalBody = articleBody;
const finalExcerpt = articleExcerpt || finalBody.substring(0, 150) + '...';
const finalTitle = articleTitle || originalKeyword;

console.log('=== âœ… æœ€çµ‚è¼¸å‡º ===');
console.log(`Title: ${finalTitle.substring(0, 50)}${finalTitle.length > 50 ? '...' : ''}`);
console.log(`Body é•·åº¦: ${finalBody.length} å­—å…ƒ`);
console.log(`Excerpt é•·åº¦: ${finalExcerpt.length} å­—å…ƒ`);

if (finalBody.length < 500) {
  console.warn(`âš ï¸ è­¦å‘Šï¼šBody é•·åº¦è¼ƒçŸ­ (${finalBody.length} å­—å…ƒ)ï¼Œå¯èƒ½åªåŒ…å«æ‘˜è¦`);
  console.warn(`Body å‰ 200 å­—: ${finalBody.substring(0, 200)}`);
}

return {
  json: {
    Keyword: originalKeyword,
    Category: originalCategory,
    GEO: originalGEO,
    title: finalTitle,
    body: finalBody,
    Content: finalBody, // âš ï¸ é‡è¦ï¼šå®Œæ•´æ–‡ç« å…§å®¹
    Excerpt: finalExcerpt,
    Status: 'done',
    Date: new Date().toISOString().split('T')[0],
    // è¨ºæ–·è³‡è¨Šï¼ˆå¯é¸ï¼Œç”¨æ–¼é™¤éŒ¯ï¼‰
    _debug: {
      bodyField: foundBodyField,
      excerptField: foundExcerptField,
      titleField: foundTitleField,
      bodyLength: finalBody.length,
      excerptLength: finalExcerpt.length
    }
  }
};

